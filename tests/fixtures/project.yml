name: SkiaWindowTests
options:
  deploymentTarget:
    macOS: "14.0"
  xcodeVersion: "15.0"

packages:
  SnapshotTesting:
    url: https://github.com/pointfreeco/swift-snapshot-testing
    exactVersion: "1.16.2"

targets:
  TestApp:
    type: application
    platform: macOS
    sources:
      - TestApp/Sources
    info:
      path: TestApp/Info.plist
    settings:
      base:
        CODE_SIGNING_ALLOWED: "NO"
        PRODUCT_BUNDLE_IDENTIFIER: com.skiawindow.testapp
        PRODUCT_NAME: TestApp
    preBuildScripts:
      - script: |
          EXEC="$BUILT_PRODUCTS_DIR/$PRODUCT_NAME.app/Contents/MacOS/$PRODUCT_NAME"
          [ -L "$EXEC" ] && rm "$EXEC"
          exit 0
        name: Clean stale deno symlink
    postBuildScripts:
      - script: |
          DENO="$(PATH="/opt/homebrew/bin:/usr/local/bin:$PATH" which deno)"
          EXEC="$BUILT_PRODUCTS_DIR/$PRODUCT_NAME.app/Contents/MacOS/$PRODUCT_NAME"
          ln -sf "$DENO" "$EXEC"
        name: Symlink deno as executable

  TestAppUITests:
    type: bundle.ui-testing
    platform: macOS
    sources:
      - ../UI
    dependencies:
      - target: TestApp
      - package: SnapshotTesting
    settings:
      base:
        CODE_SIGN_IDENTITY: "-"
        GENERATE_INFOPLIST_FILE: "YES"
        ENABLE_APP_SANDBOX: "NO"
        TEST_TARGET_NAME: TestApp
        PRODUCT_BUNDLE_IDENTIFIER: com.skiawindow.testapp.uitests

schemes:
  TestAppUITests:
    build:
      targets:
        TestApp: all
        TestAppUITests: [test]
    test:
      targets:
        - TestAppUITests
